FROM ubuntu:16.04

# For changing an owner of report files
ARG host_uid
ARG host_gid
ENV host_uid=$host_uid
ENV host_gid=$host_gid

RUN groupadd -g $host_gid benchmark_user
RUN useradd -rm -s /bin/bash -g $host_gid -G sudo -u $host_uid benchmark_user
RUN usermod -aG sudo benchmark_user

RUN apt-get -qq update && \
    apt-get -qq install -y ca-certificates wget cmake bsdtar  rsync libnss3-dev libasound2 gnuplot-x11 xvfb \
    libxtst6 libgtk2.0.0 libgconf2-4 libxss1 libopenblas-base gcc python3-dev python3-pip \
    && pip3 install --upgrade --no-cache-dir -q pip setuptools \
    && apt-get -qq clean \
    && apt-get -qq autoremove \
    && rm -rf /var/lib/apt/lists/* /tmp/* /var/tmp/*

# Scripts and styles for report and plots
RUN mkdir -p /home/benchmark_user/static \
    && wget -O /home/benchmark_user/static/materialize.min.css https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css -q \
    && wget -O /home/benchmark_user/static/plotly.min.js https://cdn.plot.ly/plotly-latest.min.js -q \
    && wget -O /home/benchmark_user/static/font.woff2 https://fonts.gstatic.com/s/materialicons/v47/flUhRq6tzZclQEJ-Vdg-IuiaDsNc.woff2 -q \
    # Download Orca AppImage
    && wget https://github.com/plotly/orca/releases/download/v1.2.1/orca-1.2.1-x86_64.AppImage -P /home -q \
    && chmod 777 /home/orca-1.2.1-x86_64.AppImage

# Make Orca executable under xvfb
RUN cd /home \
    && /home/orca-1.2.1-x86_64.AppImage --appimage-extract \
    && printf '#!/bin/bash \nxvfb-run --auto-servernum --server-args "-screen 0 1280x1024x24" /home/squashfs-root/app/orca "$@"' > /usr/bin/orca \
    && chmod 777 /usr/bin/orca \
    && chmod -R 777 /home/squashfs-root/

# Project dependencies
COPY ./benchmark/requirements.txt /home/benchmark_user/requirements.txt
RUN pip3 install --no-cache-dir -q -r /home/benchmark_user/requirements.txt

# Inner project dependencies
COPY ./main-node/core_entities /home/benchmark_user/core_entities/
COPY ./main-node/tools /home/benchmark_user/tools/
COPY ./main-node/logger /home/benchmark_user/logger/

# Copying information for benchmark
COPY ./benchmark/ /home/benchmark_user/
COPY ./main-node/Resources/ /home/benchmark_user/Resources/
## Remove not needed scenarios
COPY ./worker/csv_data/*.csv /home/benchmark_user/csv/
RUN rm /home/benchmark_user/csv/*avg.csv

WORKDIR /home/benchmark_user
RUN chown --recursive benchmark_user:benchmark_user .
USER benchmark_user

CMD [ "bash" ]